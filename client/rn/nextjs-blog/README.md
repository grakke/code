# [Learn Next.js](https://nextjs.org/learn)

- [中文教程](https://qufei1993.github.io/nextjs-learn-cn/)
- 构建一个财务 Dashboard 的简化版本，包含以下内容
  - 一个公共首页
  - 一个登录页面
  - 受身份验证保护的仪表板页面
  - 用户能够添加、编辑和删除发票

## 功能

- Styling（样式化）： 在 Next.js 中样式化应用程序的不同方法
  - 添加全局 CSS 文件, 两种不同的样式方式：
    - Tailwind
      - 通过允许在 TSX 标记中直接快速编写实用类，加速开发过程
      - 通过添加类名来为元素添加样式
    - CSS Modules
      - 允许通过自动生成独特的类名将 CSS 限定在一个组件中，不必担心样式冲突
  - 根据状态或其他条件有条件地为元素设置样式。clsx 是一个库，可以轻松地切换类名
- Optimizations（优化）： 如何优化图像、链接和字体
  - 字体
    - 累积布局移位（Cumulative Layout Shift）是 Google 用于评估网站性能和用户体验的度量标准。对于字体而言，布局移位发生在浏览器最初使用备用或系统字体呈现文本，然后在加载完自定义字体后进行替换。这种替换可能导致文本大小、间距或布局发生变化，从而使其周围的元素发生移位
    - Next.js 使用 next/font 模块时会自动优化应用程序中的字体。在构建时下载字体文件并将其托管在其他静态资产之中。意味着当用户访问您的应用程序时，不会有额外的字体网络请求，从而不会影响性能
  - 图片
    - 用 next/image 组件来自动优化图片(屏幕 设备 懒加载)
      - 图片加载时自动防止布局移位
      - 调整图像大小，避免向视口较小的设备传送大图像
      - 默认情况下懒加载图像（图像在进入视口时加载）
      - 在浏览器支持的情况下，以现代格式提供图像
- Routing（路由）： 使用文件系统路由创建嵌套布局和页面
  - 用文件系统路由，文件夹用于创建嵌套路由。每个文件夹代表一个路由段，对应到一个 URL 段
  - page.tsx 是 Next.js 的一个特殊文件，导出一个 React 组件，让该路由可访问是必需的
  - 使用布局的一个好处 部分渲染，在导航时，只有页面组件会更新，布局不会重新渲染
  - 根布局 /app/layout.tsx 添加到根布局的任何 UI 将在应用程序中的所有页面之间共享
  - <a> 元素 每次页面导航时都会出现完整的页面刷新
  - 用 <Link /> 组件在应用程序的页面之间进行链接。<Link> 允许使用 JavaScript 进行客户端导航
  - Next.js 会自动按路由段拆分您的应用程序。按路由拆分代码意味着页面变得隔离。如果某个页面抛出错误，应用程序的其余部分仍将正常工作。
  - 在生产环境中，每当 <Link> 组件出现在浏览器的视口中时，Next.js 会自动在后台预取链接路由的代码。当用户点击链接时，目标页面的代码将在后台已经加载，这就是使页面过渡几乎瞬间完成的原因
- Data Fetching（数据获取）： 如何在 Vercel 上设置数据库，以及获取和流式传输的最佳实践
  - API 是应用程序代码和数据库之间的中间层。有几种情况下可能会使用 API：
    - 如果使用提供 API 的第三方服务
    - 如果从客户端获取数据，希望有一个在服务器上运行的 API 层，以避免将数据库秘密暴露给客户端
  - 创建一个全栈应用程序时，需要编写与数据库交互的逻辑。对于像 Postgres 这样的关系数据库，可以使用 SQL 或像 Prisma 这样的 ORM 来实现
  - 使用 Server Components 获取数据
    - 默认情况下，Next.js 应用程序使用 React Server Components。使用 Server Components 获取数据是一种相对较新的方法，使用好处：
      - Server Components 支持 promises，为异步任务（如数据获取）提供了更简单的解决方案。可以使用 async/await 语法，而无需使用 useEffect、useState 或数据获取库。
      - Server Components 在服务器上执行，可以将昂贵的数据获取和逻辑保留在服务器上，并仅将结果发送到客户端
  - 数据请求无意中相互阻塞，形成请求瀑布. 一系列的网络请求序列，这些请求依赖于前面请求的完成。在数据获取的情况下，每个请求只能在前一个请求返回数据后才能开始
  - 默认情况下，Next.js 对路由进行预渲染以提高性能，这称为静态渲染。因此如果数据发生变化，不会反映在 Dashboard 中
  - 并行数据获取
    - 同时开始执行所有数据获取，可能会带来性能提升
    - 使用可应用于任何库或框架的本机 JavaScript 模式
  - 静态渲染 数据获取和渲染在构建时（部署时）或重新验证期间在服务器上进行。结果可以在内容分发网络（CDN）中分发和缓存。好处：
    - 更快的网站 - 预渲染的内容可以被缓存和全球分布。确保了世界各地的用户可以更快、更可靠地访问您的网站内容
    - 减少服务器负载 - 由于内容被缓存，服务器不必为每个用户请求动态生成内容
    - 搜索引擎优化 - 预渲染内容更容易被搜索引擎爬虫索引，因为当页面加载时，内容已经可用。可以提高搜索引擎排名
  - 静态渲染对于没有数据或跨用户共享数据的 UI（如静态博客文章或产品页面）非常有用。可能不适合具有定期更新的个性化数据的 Dashboard
  - 动态渲染 内容在请求时（当用户访问页面时）在服务器上为每个用户呈现。好处：
    - 实时数据 - 动态渲染允许应用程序显示实时或频繁更新的数据。对于数据经常变化的应用程序来说是理想的
    - 用户特定内容 - 提供个性化内容（如 Dashboard 或用户配置文件）并根据用户交互更新数据更容易
    - 请求时间信息 - 允许访问只能在请求时知道的信息，如 Cookie 或 URL 搜索参数
  - 默认情况下，@vercel/postgresql 不设置自己的缓存语义。允许框架设置自己的静态和动态行为。可以在服务器组件或数据获取函数中使用名为 unstable_noStore 的 Next.js API 来选择退出静态呈现
  - 如果一个数据请求比其他所有请求都慢，会发生什么？
    - 使用动态渲染，应用程序速度只有在最慢的数据获取完成时才能达
  - 流式传输
    - 一种数据传输技术，允许将路由分解为较小的 “chunks（块）”，并在准备就绪时逐步从服务器流式传输到客户端
    - 可以防止慢速数据请求阻塞整个页面。允许用户在等待所有数据加载之前看到和与页面的某些部分交互，而无需等待在向用户显示任何 UI 之前加载所有数据
    - 实现流式传输的方式：
      - 在页面级别使用 loading.tsx 文件
        - 一个基于 Suspense 构建的特殊 Next.js 文件，允许创建回退 UI 以在页面内容加载时显示为替代
        - 加载骨架是 UI 的简化版本。许多网站将它们用作占位符（或备用），以指示用户内容正在加载。嵌入到 loading.tsx 中的任何 UI 都将作为静态文件的一部分嵌入并首先发送。然后，服务器将其余的动态内容从服务器流式传输到客户端
        - 由于 loading.tsx 处于文件系统中 /invoices/page.tsx 和 /customers/page.tsx 的上一级，也应用于这些页面. 将 loading.tsx 和 page.tsx 文件移到该文件夹(overview)内,loading.tsx 文件将仅适用于 Dashboard 概览页面
        - 路由组允许将文件组织成逻辑组而不影响 URL 路径结构。当使用括号 () 创建一个新文件夹时，该名称将不包括在 URL 路径中。因此 /dashboard/(overview)/page.tsx 变成 /dashboard
      - 对于特定组件使用 <Suspense>
        - Suspense 允许推迟呈现应用程序的某些部分，直到满足某些条件（例如加载数据）。可以在 Suspense 中包装动态组件。然后传递一个回退组件，以在动态组件加载时显示
        - 放置 Suspense 边界的位置取决于几个因素：
          - 希望用户在页面流式传输时如何体验
            - 避免导致UI在准备就绪时突然出现在屏幕上。可以通过流式传输页面部分来创建错开效果。需要创建包装组件
          - 希望优先考虑哪些内容
          - 组件是否依赖于数据获取
  - 部分预渲染 Partial Prerendering
    - 大多数路由既不是完全静态也不是完全动态。可能有一个既包含静态又包含动态内容的路由。例如假设一个社交媒体动态，帖子可能是静态的，但帖子的点赞数是动态的。或者是电子商务网站，产品详情是静态的，但用户的购物车是动态的
    - 功能
      - 提供一个静态路由外壳，使得初始加载很快
      - 外壳中留下动态内容将异步加载
      - 异步洞在并行加载，减少页面的整体加载时间
    - 将超快的静态边缘交付与完全动态的能力结合在一起，相信有可能成为Web 应用程序的默认渲染模型，将静态站点生成和动态交付的优点融为一体
- Search and Pagination（搜索和分页）： 如何使用 URL 搜索参数实现搜索和分页
  - 使用 URL 参数实现搜索好处：
    - 书签和共享的 URL：由于搜索参数在 URL 中，用户可以将应用程序的当前状态，包括其搜索查询和过滤器，收藏夹起来以供将来参考或分享
    - 服务器端渲染和初始加载：可以直接在服务器上使用 URL 参数以呈现初始状态，使处理服务器端渲染变得更容易
    - 分析和跟踪：直接在 URL 中包含搜索查询和过滤器使得更容易跟踪用户行为，而无需额外的客户端逻辑
  - 实现搜索功能的 Next.js 客户端 hooks：
    - useSearchParams - 允许访问当前 URL 的参数。例如，此 URL /dashboard/invoices?page=1&query=pending 的搜索参数：{page: '1', query: 'pending'}
    - usePathname - 允许读取当前 URL 的路径名。例如，对于路由 /dashboard/invoices，usePathname 将返回 '/dashboard/invoices'
    - useRouter - 使您能够在客户端组件内以编程方式在路由之间导航
  - 何时使用 useSearchParams() hook vs. searchParams prop？两种不同的方法来提取搜索参数。使用其中一种取决于您是在客户端还是服务器上工作
    - <Search> 是一个客户端组件，因此使用 useSearchParams() hook 从客户端访问参数
    - <Table> 是一个服务器组件，自己获取数据，因此可以将 searchParams prop 从页面传递给组件
  - 防抖的工作原理：
    - 触发事件：当发生应该被防抖的事件（比如搜索框中的按键）时，定时器启动
    - 等待：如果在计时器到期之前发生新事件，则重置计时器
    - 执行：如果计时器达到倒计时结束，将执行防抖函数
- Mutating Data（数据突变）： 如何使用 React Server Actions 操作数据，并重新验证 Next.js 缓存
  - React Server Actions 允许在服务器上直接运行异步代码。消除了通过创建 API 改变数据的方式。相反编写的在服务器上执行的异步函数可以在客户端或 Server Components 中直接调用
  - 对于 Web 应用程序安全性是最重要的，因为可能受到各种威胁。这就是 Server Actions 发挥作用的地方。提供了一种有效的安全解决方案，防范各种类型的攻击，保护数据，并确保访问是经过授权的。Server Actions 通过诸如 POST 请求、加密闭包、严格的输入检查、错误消息 hashing 和主机限制等技术实现这一点，所有这些技术共同作用以显着增强应用程序的安全性
  - 在 React 中，可以在 <form> 元素中使用 action 属性来调用操作。该操作将自动接收包含捕获数据的原生 FormData 对象
  - 在 Server Component 中调用 Server Action 的一个优势 渐进增强 - 即使客户端上禁用了 JavaScript，forms 仍可以工作
- Error Handling（错误处理）： 如何处理一般错误和 404 未找到错误
  - 使用特殊的 error.tsx 文件捕获路由段中的错误，并向用户显示一个备用 UI
  - 使用 notFound 函数和 not-found 文件来处理 404 错误（对于不存在的资源）
- Form Validation and Accessibility（表单验证和可访问性）： 如何进行服务器端表单验证以及提高可访问性的提示
  - 可访问性是指设计和实现每个人都可以使用的 Web 应用程序，包括那些具有残障的人。这是一个广泛的主题，涵盖了许多领域，如键盘导航，语义 HTML，图像，颜色，视频等
  - 提升 form 可访问性
    - 语义化 HTML：使用语义元素（如<input>、<option> 等）而不是 <div>。这使辅助技术（AT）能够专注于输入元素，并向用户提供适当的上下文信息，使 form 更易于导航和理解
    - 标签：包括 <label> 和 htmlFor 属性确保每个 form 字段都有一个描述性的文本标签。这通过提供上下文来改善AT支持，并通过允许用户单击标签以聚焦到相应的输入字段来增强可用性
    - 聚焦轮廓（Focus Outline）：字段在聚焦时被正确地样式化，以显示轮廓。这对于可访问性至关重要，因为它在视觉上指示页面上的活动元素，帮助键盘和屏幕阅读器用户理解他们在 form 上的位置。您可以通过按 Tab 键进行验证
- Authentication（身份验证）： 如何使用 NextAuth.js 和中间件为应用程序添加身份验证
  - 身份验证是确保用户是他们所说的那个人。通过拥有的东西（如用户名和密码）证明身份
  - 授权是下一步。一旦用户的身份确认，授权决定了被允许使用应用程序中的哪些部分
- Metadata（元数据）： 如何添加元数据并为社交分享准备您的应用程序
  - 元数据提供有关网页的其他详细信息。元数据对于访问页面的用户来说是不可见的。相反在幕后工作，嵌入在页面的 HTML 中，通常位于 <head> 元素内。这些隐藏的信息对于搜索引擎和其他需要更好了解网页内容的系统非常重要
  - 类型
    - 标题元数据（Title Metadata）：负责显示在浏览器标签上的网页标题。对于 SEO 来说非常关键，因为它帮助搜索引擎了解网页的主题
    - 描述元数据（Description Metadata）：提供对网页内容的简要概述，通常显示在搜索引擎结果中
    - 关键字元数据（Keyword Metadata）：包括与网页内容相关的关键字，帮助搜索引擎索引页面
    - Open Graph 元数据（Open Graph Metadata）：当在社交媒体平台上分享时，此元数据增强了网页的表示，提供标题、描述和预览图像等信息
    - Favicon 元数据（Favicon Metadata）：将网页的图标（小图标）链接到网页，显示在浏览器的地址栏或标签中
  - 向应用程序添加元数据方法：
    - 基于配置：在 layout.js 或 page.js 文件中导出一个静态的 metadata 对象或一个动态的 generateMetadata 函数
    - 基于文件：Next.js 有一系列专门用于元数据目的的特殊文件：
      - favicon.ico、apple-icon.jpg 和 icon.jpg：用于 favicon 和图标
      - opengraph-image.jpg 和 twitter-image.jpg：用于社交媒体图片
      - robots.txt：提供搜索引擎爬取的指令
      - sitemap.xml：提供有关网站结构的信息
- #TODO
  - 身份验证出现 TypeError: Cannot read properties of undefined (reading 'substring')


```sh
npx create-next-app@latest nextjs-dashboard --use-npm --example "https://github.com/vercel/next-learn/tree/main/dashboard/starter-example"
```

## 资源

- [Next.js 官方文档](https://nextjs.org/docs)
